<div class="p-4 md:p-6 lg:p-8 bg-slate-950 min-h-screen text-slate-100">
  <!-- Modern Header -->
  <div
    class="glass-card rounded-[2.5rem] p-8 mb-10 border border-white/5 shadow-2xl animate-slide-up relative overflow-hidden">
    <!-- Abstract background decoration -->
    <div class="absolute -top-24 -right-24 w-64 h-64 bg-blue-600/10 rounded-full blur-[80px]"></div>
    <div class="absolute -bottom-24 -left-24 w-64 h-64 bg-emerald-600/10 rounded-full blur-[80px]"></div>

    <div class="relative z-10 flex flex-col xl:flex-row justify-between items-start xl:items-center gap-8">
      <div class="space-y-2">
        <h1 class="text-3xl md:text-5xl font-black text-white tracking-tight flex items-center gap-4">
          <div
            class="w-2 h-12 bg-gradient-to-b from-blue-500 to-blue-700 rounded-full shadow-[0_0_20px_rgba(59,130,246,0.5)]">
          </div>
          {{ title }}
        </h1>
        <p class="text-slate-400 text-sm md:text-base font-medium pl-6 border-l border-slate-800/50">
          Repositorio central de gestión ATSEP.
        </p>
      </div>

      <div class="flex flex-col sm:flex-row items-center gap-4 w-full xl:w-auto">
        <!-- Dashboard Search -->
        <div class="relative w-full sm:w-96 group">
          <div
            class="absolute inset-y-0 left-5 flex items-center pointer-events-none text-slate-500 group-focus-within:text-blue-400 transition-colors">
            <lucide-icon [name]="Search" [size]="20"></lucide-icon>
          </div>
          <input type="text" [(ngModel)]="filterText" placeholder="Filtrar registros..."
            class="w-full bg-slate-950/80 border border-slate-800/50 rounded-[1.5rem] py-4 pl-14 pr-6 text-white placeholder-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-600/30 focus:border-blue-500/50 transition-all shadow-inner">
        </div>

        <button (click)="openModal()"
          class="w-full sm:w-auto bg-blue-600 hover:bg-blue-500 text-white px-10 py-4 rounded-[1.5rem] flex items-center justify-center gap-3 transition-all shadow-xl shadow-blue-900/40 active:scale-95 group">
          <lucide-icon [name]="Plus" [size]="22"
            class="group-hover:rotate-90 transition-transform duration-500"></lucide-icon>
          <span class="font-black uppercase tracking-[0.15em] text-xs">Nuevo Registro</span>
        </button>
      </div>
    </div>
  </div>

  <!-- States -->
  <div *ngIf="loading"
    class="flex flex-col items-center justify-center py-40 glass-card rounded-[3rem] border border-white/5 backdrop-blur-3xl">
    <div class="relative">
      <div class="w-24 h-24 border-4 border-blue-600/5 rounded-full"></div>
      <div
        class="w-24 h-24 border-4 border-t-blue-500 border-r-blue-400/20 border-b-blue-300/10 border-l-transparent rounded-full animate-spin absolute top-0 left-0">
      </div>
    </div>
    <div class="mt-8 text-center">
      <p class="text-white font-black uppercase tracking-[0.4em] text-[10px] mb-1">Iniciando Sincronización</p>
      <div class="flex gap-1 justify-center">
        <div class="w-1 h-1 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0s"></div>
        <div class="w-1 h-1 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
        <div class="w-1 h-1 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
      </div>
    </div>
  </div>

  <!-- Content Containers -->
  <div *ngIf="!loading && !error" class="animate-slide-up" style="animation-delay: 0.1s">

    <!-- DESKTOP TABLE VIEW (XL+ ONLY) -->
    <div class="hidden xl:block glass-card rounded-[2.5rem] overflow-hidden border border-white/5 shadow-2xl">
      <div class="overflow-x-auto custom-scrollbar">
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-slate-950/60 backdrop-blur-md">
              <ng-container *ngFor="let col of columns">
                <th *ngIf="!col.virtual && !col.hideInTable"
                  class="px-10 py-7 text-left text-[11px] font-black text-slate-500 uppercase tracking-[0.3em] border-b border-white/[0.03]">
                  {{ col.label }}
                </th>
              </ng-container>
              <th
                class="px-10 py-7 text-right text-[11px] font-black text-slate-500 uppercase tracking-[0.3em] border-b border-white/[0.03]">
                Acciones</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-white/[0.02]">
            <tr *ngFor="let item of filteredItems" class="hover:bg-blue-500/[0.04] transition-all group">
              <ng-container *ngFor="let col of columns">
                <td *ngIf="!col.virtual && !col.hideInTable" class="px-10 py-6 text-sm text-slate-300">
                  <ng-container *ngIf="col.renderCell; else defaultCell">
                    <span class="font-bold text-slate-200">{{ col.renderCell($any(item)) }}</span>
                  </ng-container>
                  <ng-template #defaultCell>
                    <div class="flex flex-col">
                      <span class="font-semibold text-slate-200 group-hover:text-blue-400 transition-colors"
                        [title]="col.relation ? getRelationLabel(col, getItemValue($any(item), col.key)) : getItemValue($any(item), col.key)">
                        {{ col.relation ? getRelationLabel(col, getItemValue($any(item), col.key)) :
                        getItemValue($any(item), col.key) }}
                      </span>
                    </div>
                  </ng-template>
                </td>
              </ng-container>
              <td class="px-10 py-6 text-right">
                <div
                  class="flex justify-end gap-2 opacity-10 xl:opacity-0 group-hover:opacity-100 transition-all items-center">
                  <button (click)="openModal($any(item), true)"
                    class="p-2.5 text-emerald-400 hover:text-emerald-300 hover:bg-emerald-400/10 rounded-2xl transition-all"
                    title="Ver Detalle">
                    <lucide-icon [name]="Eye" [size]="20"></lucide-icon>
                  </button>
                  <button (click)="openModal($any(item), false)"
                    class="p-2.5 text-blue-400 hover:text-blue-300 hover:bg-blue-400/10 rounded-2xl transition-all"
                    title="Editar">
                    <lucide-icon [name]="Edit" [size]="20"></lucide-icon>
                  </button>
                  <button (click)="handleDelete($any(item).id)"
                    class="p-2.5 text-red-500 hover:text-red-400 hover:bg-red-500/10 rounded-2xl transition-all"
                    title="Borrar">
                    <lucide-icon [name]="Trash2" [size]="20"></lucide-icon>
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="filteredItems.length === 0">
              <td [attr.colspan]="columns.length + 1" class="px-10 py-20 text-center">
                <div class="flex flex-col items-center gap-3">
                  <lucide-icon [name]="Search" [size]="48" class="text-slate-700"></lucide-icon>
                  <p class="text-slate-500 font-bold uppercase tracking-widest text-xs">No se encontraron resultados
                    para "{{ filterText }}"</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- MOBILE/TABLET CARD VIEW (Visible below XL) -->
    <div class="xl:hidden grid grid-cols-1 md:grid-cols-2 gap-6">
      <div *ngFor="let item of filteredItems"
        class="glass-card rounded-[2.5rem] p-8 shadow-2xl hover:border-blue-500/40 transition-all flex flex-col justify-between group relative overflow-hidden">

        <div class="absolute top-0 right-0 w-32 h-32 bg-blue-600/5 rounded-full blur-2xl -mr-16 -mt-16"></div>

        <div class="space-y-6">
          <div class="flex justify-between items-center border-b border-white/[0.03] pb-4">
            <div class="flex flex-col">
              <span class="text-xs font-black text-blue-500 uppercase tracking-[0.2em] mb-1">Registro</span>
              <span class="text-xl font-black text-white">#{{ $any(item).id }}</span>
            </div>
            <div class="flex gap-2">
              <button (click)="openModal($any(item), true)"
                class="p-3 bg-white/5 hover:bg-emerald-500/10 text-slate-400 hover:text-emerald-400 rounded-2xl transition-all">
                <lucide-icon [name]="Eye" [size]="20"></lucide-icon>
              </button>
              <button (click)="openModal($any(item), false)"
                class="p-3 bg-white/5 hover:bg-blue-500/10 text-slate-400 hover:text-blue-400 rounded-2xl transition-all">
                <lucide-icon [name]="Edit" [size]="20"></lucide-icon>
              </button>
            </div>
          </div>

          <div class="space-y-6">
            <ng-container *ngFor="let col of columns">
              <div *ngIf="!col.virtual && !col.hideInTable" class="flex flex-col gap-1.5">
                <label class="text-[10px] font-black text-slate-500 uppercase tracking-[0.25em]">{{ col.label }}</label>
                <span class="text-[15px] text-slate-200 font-bold leading-relaxed">
                  <ng-container *ngIf="col.renderCell; else defaultCellMobile">
                    {{ col.renderCell($any(item)) }}
                  </ng-container>
                  <ng-template #defaultCellMobile>
                    {{ col.relation ? getRelationLabel(col, getItemValue($any(item), col.key)) :
                    getItemValue($any(item), col.key) }}
                  </ng-template>
                </span>
              </div>
            </ng-container>
          </div>
        </div>

        <div class="mt-8 pt-6 border-t border-white/[0.03]">
          <button (click)="handleDelete($any(item).id)"
            class="w-full py-4 bg-red-500/5 hover:bg-red-500/10 text-red-500/40 hover:text-red-500 text-[10px] font-black uppercase tracking-[0.2em] rounded-2xl border border-red-500/10 transition-all flex items-center justify-center gap-3">
            <lucide-icon [name]="Trash2" [size]="16"></lucide-icon>
            Eliminar de la Base
          </button>
        </div>
      </div>

      <!-- No results mobile -->
      <div *ngIf="filteredItems.length === 0" class="col-span-full py-20 glass-card rounded-[2.5rem] text-center">
        <div class="flex flex-col items-center gap-4">
          <lucide-icon [name]="Search" [size]="48" class="text-slate-800"></lucide-icon>
          <p class="text-slate-600 font-black uppercase tracking-[0.2em] text-xs">Sin coincidencias para "{{ filterText
            }}"</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Advanced Form Modal -->
  <app-modal [isOpen]="isModalOpen" (onClose)="isModalOpen = false"
    [title]="(isReadOnly ? 'Ficha Técnica' : (currentItem ? 'Modificar Registro' : 'Nuevo Ingreso'))">
    <form (ngSubmit)="handleSubmit()" class="space-y-8 max-h-[75vh] overflow-y-auto px-4 custom-scrollbar lg:px-6">
      <div class="grid grid-cols-1 gap-8">
        <ng-container *ngFor="let col of columns">
          <div *ngIf="!col.virtual && !col.hideInForm" class="space-y-3">
            <label class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] pl-1">{{ col.label }}</label>

            <!-- Relation Select -->
            <div *ngIf="col.relation" class="relative group">
              <select name="{{ col.key }}" [(ngModel)]="formData[col.key]"
                class="w-full bg-slate-950/80 border border-slate-800/80 rounded-[1.2rem] px-5 py-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-600/40 focus:border-blue-500 transition-all appearance-none disabled:bg-slate-900/50 disabled:text-slate-500 font-semibold"
                [required]="!col.optional" [disabled]="isReadOnly">
                <option value="">Seleccionar {{ col.label }}...</option>
                <option *ngFor="let opt of getFilteredOptions(col)" [value]="$any(opt).id">
                  {{ getDisplayLabel(col, opt) }}
                </option>
              </select>
              <div
                class="absolute right-5 top-1/2 -translate-y-1/2 pointer-events-none text-slate-600 group-focus-within:text-blue-500 transition-colors">
                <lucide-icon [name]="Plus" [size]="16" class="rotate-45"></lucide-icon>
              </div>
            </div>

            <!-- Enum/Options Select -->
            <div *ngIf="col.type === 'select'" class="relative group">
              <select name="{{ col.key }}" [(ngModel)]="formData[col.key]"
                class="w-full bg-slate-950/80 border border-slate-800/80 rounded-[1.2rem] px-5 py-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-600/40 focus:border-blue-500 transition-all appearance-none disabled:bg-slate-900/50 disabled:text-slate-500 font-semibold"
                [required]="!col.optional" [disabled]="isReadOnly">
                <option value="">Selección de categoría...</option>
                <option *ngFor="let opt of col.options" [value]="opt">{{ opt }}</option>
              </select>
              <div
                class="absolute right-5 top-1/2 -translate-y-1/2 pointer-events-none text-slate-600 group-focus-within:text-blue-500 transition-colors">
                <lucide-icon [name]="Plus" [size]="16" class="rotate-45"></lucide-icon>
              </div>
            </div>

            <!-- Standard Input -->
            <input *ngIf="!col.relation && col.type !== 'select'" [type]="col.type || 'text'" name="{{ col.key }}"
              [(ngModel)]="formData[col.key]"
              class="w-full bg-slate-950/80 border border-slate-800/80 rounded-[1.2rem] px-5 py-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-600/40 focus:border-blue-500 transition-all disabled:bg-slate-900/50 disabled:text-slate-500 placeholder-slate-800 font-semibold"
              [placeholder]="'Completar ' + col.label.toLowerCase()" [required]="!col.optional"
              [disabled]="isReadOnly" />
          </div>
        </ng-container>
      </div>

      <!-- Action Buttons -->
      <div class="flex flex-col sm:flex-row justify-end gap-4 mt-12 pt-8 border-t border-white/[0.05]">
        <button type="button" (click)="isModalOpen = false"
          class="order-2 sm:order-1 px-10 py-4 bg-slate-900 hover:bg-slate-800 rounded-2xl text-slate-400 font-black text-[10px] uppercase tracking-[0.2em] transition-all border border-white/5">
          {{ isReadOnly ? 'Finalizar Vista' : 'Descartar' }}
        </button>
        <button *ngIf="!isReadOnly" type="submit"
          class="order-1 sm:order-2 px-10 py-4 bg-blue-600 hover:bg-blue-500 rounded-2xl text-white font-black text-[10px] uppercase tracking-[0.2em] transition-all shadow-2xl shadow-blue-900/60 active:scale-95">
          {{ currentItem ? 'Actualizar Servidor' : 'Confirmar Registro' }}
        </button>
      </div>
    </form>
  </app-modal>
</div>